# Phase 1.7: Automatic User Context

**Status**: ⚠️ Superseded by Phase 1.10
**Updated**: December 18, 2025

## Overview

~~Updated middleware to automatically fetch the current user's ID from Fliplet's session, rather than requiring it as a parameter.~~

**This approach has been superseded by [Phase 1.10: Session Cookie Authentication](./1.10-session-cookie-authentication.md).**

The new approach uses `$.ajax()` with `withCredentials: true` to inherit Studio session cookies, eliminating the need to extract userId manually. The API backend determines the user from the authenticated session.

---

## Changes Made

### Before: Manual userId Parameter

```javascript
/**
 * Get apps in organization for specific user
 * @param {number} organizationId
 * @param {number} userId - Must be provided by caller
 * @param {Object} options
 */
getOrganizationApps: function(organizationId, userId, options) {
  if (!organizationId) throw new Error('organizationId is required');
  if (!userId) throw new Error('userId is required');
  // ...
  return request('GET', '/organizations/' + organizationId + '/users/' + userId + '/apps' + query);
}
```

**Problems:**
- Caller must track and provide userId
- Extra parameter in every call
- Prone to errors (passing wrong userId)
- Violates DRY principle (userId same across all calls in a session)

### After: Automatic User Context

```javascript
/**
 * Get apps in organization for current user
 * @param {number} organizationId
 * @param {Object} options
 */
getOrganizationApps: function(organizationId, options) {
  if (!organizationId) throw new Error('organizationId is required');
  options = options || {};

  // Get current user ID from Fliplet session automatically (with safe null checking)
  var session = Fliplet.User.getCachedSession();
  if (!session || !session.user || !session.user.id) {
    throw new Error('User session not found. Please ensure user is logged in.');
  }
  var userId = session.user.id;

  var query = buildQueryString({
    publisher: options.publisherOnly,
    mergeable: options.mergeableOnly
  });
  return request('GET', '/organizations/' + organizationId + '/users/' + userId + '/apps' + query);
}
```

**Benefits:**
- ✅ Simpler API - one less parameter
- ✅ No risk of passing wrong userId
- ✅ Consistent with Fliplet patterns
- ✅ Clear error message if session missing

---

## Usage Examples

### Before (Manual userId)

```javascript
// Caller had to get userId separately
const userId = Fliplet.User.getCachedSession().user.id;
const result = await MergeAPI.getOrganizationApps(123, userId, {
  publisherOnly: true
});
```

### After (Automatic)

```javascript
// Middleware handles userId automatically
const result = await MergeAPI.getOrganizationApps(123, {
  publisherOnly: true
});
```

---

## API Tester Update

### Before
```javascript
getOrganizationApps: [
  {name:'organizationId', type:'number', required:true},
  {name:'userId', type:'number', required:true},
  {name:'options', type:'object', required:false}
]
```

**UI showed 3 input fields:**
- organizationId *
- userId *
- options

### After
```javascript
getOrganizationApps: [
  {name:'organizationId', type:'number', required:true},
  {name:'options', type:'object', required:false}
]
```

**UI shows 2 input fields:**
- organizationId *
- options

---

## Design Principle

This change aligns with the **Middleware Guidelines** principle:

> **Handle Common Concerns Automatically**
> Middleware should abstract away repetitive patterns. If every caller needs to do the same thing (like getting the current user ID), the middleware should handle it.

### When to Auto-Fetch vs. Require Parameter

**Auto-fetch from context when:**
- Value is the same for all calls in a session (userId, authToken)
- Value is available via global API (Fliplet.User, Fliplet.Env)
- There's no valid use case for overriding it

**Require as parameter when:**
- Value varies per call (appId, pageId, dataSourceId)
- Caller has specific intent (sourceAppId vs targetAppId)
- Value represents user choice or selection

---

## Potential Future Applications

This pattern could be applied to other middleware functions that might need userId in the future:

### Possible Candidates
```javascript
// If we add user-scoped operations:
getUserPreferences()  // No userId param needed
saveUserPreferences(prefs)  // No userId param needed
getUserMergeHistory()  // No userId param needed
```

### NOT Applicable
```javascript
// These still need explicit IDs - they're about OTHER entities:
getAppDetails(appId)  // ✅ Keep param - selecting which app
lockApps(sourceAppId, targetAppId)  // ✅ Keep params - explicit intent
```

---

## Error Handling

The middleware now provides clear error messages when user context is missing:

```javascript
var userId = Fliplet.User.getCachedSession().user.id;
if (!userId) {
  throw new Error('User session not found. Please ensure user is logged in.');
}
```

**Error scenarios:**
1. User not logged in → Clear error message
2. Session expired → Clear error message
3. Invalid session → Clear error message

**Compared to before:**
- Before: `GET /v1/organizations/123/users/undefined/apps` → 400 Bad Request
- After: Immediate error with actionable message

---

## Testing

### API Tester
1. Open API Tester screen
2. Select category: `apps`
3. Select function: `getOrganizationApps`
4. Enter only organizationId (e.g., `2`)
5. Click "Run"
6. ✅ Should work if user is logged in
7. ❌ Should show clear error if session missing

### In Production Screens
```javascript
// Dashboard screen - fetching apps for destination selection
try {
  const result = await MergeAPI.getOrganizationApps(selectedOrgId, {
    publisherOnly: true,
    mergeableOnly: true
  });
  this.apps = result.apps;
} catch (error) {
  // Will show "User session not found..." if not logged in
  console.error('Failed to fetch apps:', error.message);
}
```

---

## Documentation Updates

### Files Updated:
1. ✅ Global JavaScript - `getOrganizationApps()` function signature
2. ✅ API Tester - Removed userId from signatures
3. ✅ `1.3-api-middleware.md` - Updated function signature
4. ✅ `1.6-api-fixes.md` - Updated validation list
5. ✅ `1.7-automatic-user-context.md` - This document (new)

---

## Summary

**What Changed:**
- `getOrganizationApps(orgId, userId, options)` → `getOrganizationApps(orgId, options)`

**Why:**
- userId is always the current user - no reason to require it as parameter
- Simpler, cleaner API
- Follows Fliplet patterns and middleware guidelines

**Impact:**
- API Tester: One fewer input field
- Production code: Simpler function calls
- Error messages: More helpful and immediate

---

## Migration to Phase 1.10

**This implementation has been replaced.** See [Phase 1.10: Session Cookie Authentication](./1.10-session-cookie-authentication.md) for the current approach.

### Key Differences

**Phase 1.7 (Old)**:
- Extracted userId from `Fliplet.User.getCachedSession()`
- Required manual session checking
- Used `Fliplet.API.request()`

**Phase 1.10 (Current)**:
- Uses cookie-based authentication with `$.ajax()`
- No userId extraction needed
- API determines user from session automatically
- Supports multi-region via `apiUrl` query parameter

---

**Status**: Superseded by Phase 1.10 ⚠️

