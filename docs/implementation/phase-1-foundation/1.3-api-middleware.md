# Phase 1.3: API Middleware Layer

## Objective

Create a modular middleware layer that provides behavior-parameterized functions for all backend API interactions, following the [middleware development guidelines](../../MIDDLEWARE_GUIDELINES.md).

## Prerequisites

- Phase 1.1 (Project Setup) completed
- Understanding of the [API Technical Specification](../../05-api-tech-spec.md)
- Familiarity with middleware development principles

## Implementation

See the complete middleware implementation in the main plan document (section 1.3).

### Key Middleware Functions

#### Apps API
- `getApps(options)` - List apps for an organization
- `getAppDetails(appId, options)` - Get specific app details
- `checkDuplicates(appId, options)` - Check for duplicate screens/data sources

#### Organizations API
- `getOrganizations(options)` - List user organizations

#### Screens API
- `getScreens(appId, options)` - List screens with optional associations
- `getScreenDetails(appId, pageId, options)` - Get specific screen details

#### Data Sources API
- `getDataSources(appId, options)` - List data sources with options
- `getDataSourceDetails(dataSourceId, appId, options)` - Get specific DS details

#### Files API
- `getFiles(appId, options)` - List files with associations
- `getFileDetails(fileId, appId, options)` - Get file details
- `getFolderDetails(folderId, appId, options)` - Get folder details

#### Lock Management API
- `lockApps(sourceAppId, targetApp, options)` - Lock source and destination apps
- `unlockApps(sourceAppId, targetApp, options)` - Unlock apps
- `extendLock(sourceAppId, targetApp, options)` - Extend lock duration

#### Merge Operations API
- `previewMerge(sourceAppId, config)` - Preview merge results
- `executeMerge(sourceAppId, config)` - Execute the merge
- `getMergeStatus(sourceAppId, mergeId)` - Poll merge status

#### Logging API
- `getAppLogs(appId, filter)` - Fetch app audit logs

#### Global Code API
- `getGlobalCodeVersions(appId, options)` - List global code versions
- `restoreGlobalCodeVersion(appId, versionId, options)` - Restore a version

## Middleware Principles

Per [MIDDLEWARE_GUIDELINES.md](../../MIDDLEWARE_GUIDELINES.md):

1. **Intent-Based Parameters** - Functions accept options describing *what behavior is needed*, not *who is calling*
2. **Explicit Over Implicit** - All behavior must be explicitly requested through parameters
3. **No Caller Assumptions** - No magic defaults based on guessed caller intent
4. **Consistent Error Handling** - Transform API errors into actionable error objects

### Example Usage

```javascript
// Good: Explicit behavior parameters
MergeAPI.getScreens(123, {
  include: ['associatedDS', 'associatedFiles']
});

// Bad: Caller identification
// MergeAPI.getScreens(123, 'dashboard'); // DON'T DO THIS
```

## Error Handling

```javascript
function handleResponse(response) {
  if (!response.ok) {
    return response.json().then(function(error) {
      throw new Error(error.message || 'API request failed');
    }).catch(function() {
      throw new Error('API request failed with status ' + response.status);
    });
  }
  return response.json();
}
```

## Testing

Before using in production screens, validate each middleware function using the [API Testing Screen](./1.4-api-tester.md).

## Verification

- [ ] All middleware functions are implemented in Global JS
- [ ] Functions follow behavior-parameterized design
- [ ] Error handling is consistent across all functions
- [ ] No caller-specific logic exists in any function
- [ ] Functions can be called from any screen
- [ ] Documentation includes parameter descriptions

## Next Steps

Proceed to [1.4 API Testing Screen](./1.4-api-tester.md) to build the testing interface.

## Related Documents

- [Middleware Development Guidelines](../../MIDDLEWARE_GUIDELINES.md)
- [API Technical Specification](../../05-api-tech-spec.md)
- [Phase 1 Overview](../00-overview.md#phase-1-foundation--design-system)

