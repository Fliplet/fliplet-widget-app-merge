# Phase 1.11: UserId in Endpoint URL Path

**Status**: ✅ Complete
**Updated**: December 18, 2025
**Related**: Extends Phase 1.10 (Session Cookie Authentication)

## Problem Identified

The initial Phase 1.10 implementation simplified the endpoint from:
```
GET /v1/organizations/:orgId/users/:userId/apps
```

To:
```
GET /v1/organizations/:orgId/apps
```

**Why This Was Wrong**:
- The API uses userId for **user-scoped filtering**
- Organization admins could potentially see apps they're not assigned to
- Violated the API contract documented in `docs/05-api-tech-spec.md`

## Solution

### 1. Added `getCurrentUser()` Middleware Function

**Purpose**: Fetch authenticated Studio user's details via Studio session cookies

**Implementation**:
```javascript
/**
 * Get current authenticated user from Studio session
 * Uses Studio session cookies to determine user identity
 * @returns {Promise<{user: Object, session: Object, region: string}>}
 */
getCurrentUser: function() {
  return request('GET', '/user');
}
```

**Response Structure**:
```javascript
{
  "user": {
    "id": 123,  // ← This is what we need
    "firstName": "John",
    "lastName": "Doe",
    "email": "john.doe@example.com",
    // ... other fields
  },
  "session": { /* session data */ },
  "host": "api.fliplet.com",
  "region": "eu"
}
```

### 2. Updated `getOrganizationApps()` to Use Explicit UserId

**New Flow**:
1. Auto-detect `organizationId` from Studio environment (`Fliplet.Env.get('organizationId')`)
2. Call `getCurrentUser()` to fetch Studio user details
3. Extract `userId` from response
4. Use both organizationId and userId in the endpoint URL path
5. API validates user has permission to access those apps

**Implementation**:
```javascript
getOrganizationApps: function(organizationId, options) {
  // Handle single-argument case where first arg is options
  if (typeof organizationId === 'object' && organizationId !== null && !options) {
    options = organizationId;
    organizationId = null;
  }
  options = options || {};

  // Auto-detect organizationId from Studio environment
  if (!organizationId) {
    organizationId = Fliplet.Env.get('organizationId');
  }
  if (!organizationId) {
    throw new Error('organizationId is required and could not be auto-detected');
  }

  // Get current user from Studio session to determine userId
  // This ensures we only fetch apps assigned to the authenticated user
  return this.getCurrentUser().then(function(response) {
    var userId = response.user && response.user.id;
    if (!userId) {
      throw new Error('Unable to determine user ID from Studio session');
    }

    var query = buildQueryString({
      publisher: options.publisherOnly,
      mergeable: options.mergeableOnly
    });

    // Use full endpoint path with userId for proper user-scoped filtering
    return request('GET', '/organizations/' + organizationId + '/users/' + userId + '/apps' + query);
  });
}
```

## Why UserId in URL Path Matters

### 1. **Security Boundary**
- Prevents organization admins from accessing apps they shouldn't see
- API validates the userId has permission to access the requested apps

### 2. **Explicit Intent**
- Makes it clear which user's apps are being requested
- No ambiguity about whose permissions apply

### 3. **API Contract Compliance**
- Matches the documented endpoint in `docs/05-api-tech-spec.md`
- Aligns with existing API design patterns

### 4. **User-Scoped Filtering**
- Backend filters apps by explicit user assignment
- Respects role-based access control (RBAC)

## Authentication Flow

```
┌─────────────────────────────────────────────────────────────┐
│ 1. Web app loaded in Studio iFrame                         │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. MergeAPI.getOrganizationApps(orgId, options)           │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. Call this.getCurrentUser()                              │
│    → request('GET', '/user')                                │
│    → $.ajax({ withCredentials: true })                      │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ 4. Browser sends Studio session cookies automatically      │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ 5. API validates cookies, returns user details             │
│    Response: { user: { id: 123, ... } }                    │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ 6. Extract userId = 123 from response                      │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ 7. Make API call with explicit userId in path              │
│    → GET /organizations/2/users/123/apps?publisher=true    │
│    → $.ajax({ withCredentials: true })                      │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ 8. API validates user 123 has permission                   │
│    Returns apps assigned to that user                       │
└─────────────────────────────────────────────────────────────┘
```

## Key Differences from Phase 1.10

| Aspect | Phase 1.10 (Original) | Phase 1.11 (Fixed) |
|--------|----------------------|-------------------|
| **Endpoint** | `/organizations/:orgId/apps` | `/organizations/:orgId/users/:userId/apps` |
| **UserId Source** | API infers from session | Client fetches via `getCurrentUser()` |
| **Security** | Implicit filtering | Explicit user-scoped filtering |
| **API Contract** | Diverged from spec | Matches documented spec |
| **New Function** | N/A | `MergeAPI.getCurrentUser()` |

## Files Updated

1. **Global JavaScript (App 427998)**
   - Added `getCurrentUser()` function
   - Updated `getOrganizationApps()` to call `getCurrentUser()` and use userId in URL

2. **Documentation**
   - `docs/implementation/phase-1-foundation/1.10-session-cookie-authentication.md`
   - `GLOBAL_JS_UPDATE.js`
   - This file (`1.11-userid-endpoint-fix.md`)

## Testing Checklist

- [ ] `MergeAPI.getCurrentUser()` returns user details with valid `user.id`
- [ ] `MergeAPI.getOrganizationApps(orgId)` calls `getCurrentUser()` first
- [ ] Network tab shows endpoint: `GET /organizations/:orgId/users/:userId/apps`
- [ ] Cookie header is present in all requests
- [ ] Organization admin only sees apps they're assigned to
- [ ] Multi-region support still works with `?apiUrl=...` query param

## Benefits

1. ✅ **Proper Permission Boundaries**: Users only see their assigned apps
2. ✅ **API Compliance**: Matches documented endpoint specification
3. ✅ **Explicit User Context**: Clear which user's permissions apply
4. ✅ **Maintains Cookie Auth**: Still uses `withCredentials: true` for authentication
5. ✅ **Multi-Region Support**: Works across different API regions

## Enhancement: Phase 1.12

Phase 1.12 further improved this function by making `organizationId` optional with auto-detection:

```javascript
// Phase 1.12: organizationId now auto-detected from Studio
MergeAPI.getOrganizationApps({ publisherOnly: true })

// Still supports explicit organizationId
MergeAPI.getOrganizationApps(2, { publisherOnly: true })
```

See [Phase 1.12: Auto-Detect Organization ID](./1.12-auto-detect-organization.md) for details.

## Related Documentation

- [Phase 1.12: Auto-Detect Organization ID](./1.12-auto-detect-organization.md) - **Latest enhancement**
- [Phase 1.10: Session Cookie Authentication](./1.10-session-cookie-authentication.md)
- [API Tech Spec - Get User Apps In An Organization](../../05-api-tech-spec.md#get-user-apps-in-an-organization)
- [Middleware Guidelines](../../MIDDLEWARE_GUIDELINES.md)

---

**Implementation Date**: December 18, 2025
**Deployed**: App 427998 Global JavaScript
**Status**: ✅ Complete (Enhanced by Phase 1.12)
