# Phase 1.1: Project Setup & Global Architecture

## Objective

Set up the app context and establish the global code structure including design tokens, state management, and core utilities.

## Prerequisites

- Access to App ID 427998
- Fliplet Studio access with appropriate permissions
- Understanding of Vue.js 3 and Fliplet platform

## Steps

### 1. Set App Context

Use the `set_app_context` tool to configure the working environment:

```javascript
// Set context to App ID 427998
```

### 2. Create Global CSS with Design Tokens

Create comprehensive design tokens aligned with Fliplet's design system:

```css
:root {
  /* Colors - Fliplet Brand Palette */
  --primary-color: #00abd1;
  --secondary-color: #36344c;
  --success-color: #19cd9d;
  --warning-color: #ed9119;
  --danger-color: #e03629;
  --info-color: #4e5169;

  /* Status colors for merge preview */
  --status-overwrite: #ff9800;
  --status-copy: #4caf50;
  --status-conflict: #f44336;
  --status-partial: #2196f3;

  /* Spacing Scale */
  --spacing-xs: 4px;
  --spacing-sm: 8px;
  --spacing-md: 16px;
  --spacing-lg: 24px;
  --spacing-xl: 32px;
  --spacing-xxl: 48px;

  /* Typography */
  --font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
  --font-size-xs: 11px;
  --font-size-sm: 12px;
  --font-size-base: 14px;
  --font-size-lg: 16px;
  --font-size-xl: 20px;
  --font-size-xxl: 24px;

  /* Font Weights */
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 600;
  --font-weight-bold: 700;

  /* Line Heights */
  --line-height-tight: 1.2;
  --line-height-normal: 1.5;
  --line-height-relaxed: 1.75;

  /* Shadows */
  --shadow-xs: 0 1px 2px rgba(0,0,0,0.05);
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
  --shadow-lg: 0 10px 20px rgba(0,0,0,0.15);
  --shadow-xl: 0 20px 25px rgba(0,0,0,0.15);

  /* Borders */
  --border-radius-sm: 2px;
  --border-radius: 4px;
  --border-radius-md: 6px;
  --border-radius-lg: 8px;
  --border-radius-xl: 12px;
  --border-radius-full: 9999px;
  --border-width: 1px;
  --border-color: #dee2e6;
  --border-color-light: #e9ecef;

  /* Z-index Scale */
  --z-dropdown: 1000;
  --z-sticky: 1020;
  --z-fixed: 1030;
  --z-modal-backdrop: 1040;
  --z-modal: 1050;
  --z-popover: 1060;
  --z-tooltip: 1070;

  /* Transitions */
  --transition-fast: 150ms ease-in-out;
  --transition-base: 250ms ease-in-out;
  --transition-slow: 350ms ease-in-out;
}

/* Base Styles */
body {
  font-family: var(--font-family);
  font-size: var(--font-size-base);
  line-height: var(--line-height-normal);
  color: var(--secondary-color);
}

/* Container Styles */
.merge-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: var(--spacing-lg);
}

/* Utility Classes */
.text-primary { color: var(--primary-color); }
.text-secondary { color: var(--secondary-color); }
.text-success { color: var(--success-color); }
.text-warning { color: var(--warning-color); }
.text-danger { color: var(--danger-color); }
.text-info { color: var(--info-color); }

.bg-primary { background-color: var(--primary-color); }
.bg-secondary { background-color: var(--secondary-color); }
.bg-success { background-color: var(--success-color); }
.bg-warning { background-color: var(--warning-color); }
.bg-danger { background-color: var(--danger-color); }
.bg-info { background-color: var(--info-color); }

/* Spacing Utilities */
.m-0 { margin: 0; }
.mt-1 { margin-top: var(--spacing-xs); }
.mt-2 { margin-top: var(--spacing-sm); }
.mt-3 { margin-top: var(--spacing-md); }
.mt-4 { margin-top: var(--spacing-lg); }
.mt-5 { margin-top: var(--spacing-xl); }

.mb-1 { margin-bottom: var(--spacing-xs); }
.mb-2 { margin-bottom: var(--spacing-sm); }
.mb-3 { margin-bottom: var(--spacing-md); }
.mb-4 { margin-bottom: var(--spacing-lg); }
.mb-5 { margin-bottom: var(--spacing-xl); }

.p-0 { padding: 0; }
.p-1 { padding: var(--spacing-xs); }
.p-2 { padding: var(--spacing-sm); }
.p-3 { padding: var(--spacing-md); }
.p-4 { padding: var(--spacing-lg); }
.p-5 { padding: var(--spacing-xl); }
```

### 3. Create Global JavaScript Structure

Set up Vue.js, state management, and utilities:

```javascript
/**
 * App Merge - Global JavaScript
 * Dependencies: Vue.js 3, Fliplet.UI.Table
 */

// Import Vue.js 3 from CDN
(function() {
  var script = document.createElement('script');
  script.src = 'https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js';
  script.onload = function() {
    console.log('Vue.js 3 loaded successfully');
    window.dispatchEvent(new Event('vue-loaded'));
  };
  document.head.appendChild(script);
})();

// Global State Management
window.MergeState = {
  // Source app (set by Studio when opening merge UI)
  sourceApp: null,

  // Selected destination app
  destinationApp: null,

  // Selected items for merge
  selectedScreens: [],
  selectedDataSources: [],
  selectedFiles: [],
  selectedFolders: [],

  // Data source merge modes
  dataSourceModes: {}, // { dataSourceId: 'all' | 'structure' }

  // Folder merge modes
  folderModes: {}, // { folderId: 'folder' | 'all' }

  // App-level configuration selections
  appLevelConfig: {
    mergeAppSettings: false,
    mergeMenuSettings: false,
    mergeAppearanceSettings: false,
    mergeGlobalCode: false
  },

  // Lock management
  lockInfo: {
    lockedUntil: null,
    timeRemaining: null,
    lockExtensionCount: 0
  },

  // Merge execution
  mergeStatus: null,
  mergeId: null,
  mergeResult: null,

  // Navigation
  currentScreen: 'dashboard', // dashboard | select-destination | configure-merge | review-merge | executing | complete

  // UI state
  loading: false,
  error: null
};

// Event Bus for component communication
window.MergeEventBus = null; // Will be initialized after Vue loads

// Storage wrapper for localStorage persistence
window.MergeStorage = {
  save: function(key, value) {
    return Fliplet.App.Storage.set('merge_' + key, value);
  },

  get: function(key) {
    return Fliplet.App.Storage.get('merge_' + key);
  },

  remove: function(key) {
    return Fliplet.App.Storage.remove('merge_' + key);
  },

  clear: function() {
    return Fliplet.App.Storage.clear();
  },

  // Save entire merge state
  saveState: function() {
    return this.save('state', {
      sourceApp: MergeState.sourceApp,
      destinationApp: MergeState.destinationApp,
      selectedScreens: MergeState.selectedScreens,
      selectedDataSources: MergeState.selectedDataSources,
      selectedFiles: MergeState.selectedFiles,
      selectedFolders: MergeState.selectedFolders,
      dataSourceModes: MergeState.dataSourceModes,
      folderModes: MergeState.folderModes,
      appLevelConfig: MergeState.appLevelConfig,
      mergeId: MergeState.mergeId,
      timestamp: Date.now()
    });
  },

  // Restore merge state
  restoreState: function() {
    var self = this;
    return this.get('state').then(function(savedState) {
      if (savedState && savedState.timestamp) {
        // Check if state is less than 24 hours old
        var age = Date.now() - savedState.timestamp;
        if (age < 24 * 60 * 60 * 1000) {
          Object.assign(MergeState, savedState);
          return true;
        }
      }
      return false;
    });
  }
};

// Utility Functions
window.MergeUtils = {
  // Format date/time
  formatDate: function(dateString) {
    if (!dateString) return '-';
    var date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
  },

  // Format relative time (e.g., "2 hours ago")
  formatRelativeTime: function(dateString) {
    if (!dateString) return '-';
    var date = new Date(dateString);
    var now = new Date();
    var diff = now - date;

    var minutes = Math.floor(diff / 60000);
    var hours = Math.floor(diff / 3600000);
    var days = Math.floor(diff / 86400000);

    if (minutes < 1) return 'Just now';
    if (minutes < 60) return minutes + ' minute' + (minutes > 1 ? 's' : '') + ' ago';
    if (hours < 24) return hours + ' hour' + (hours > 1 ? 's' : '') + ' ago';
    return days + ' day' + (days > 1 ? 's' : '') + ' ago';
  },

  // Format file size
  formatFileSize: function(bytes) {
    if (!bytes) return '-';
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    if (bytes < 1073741824) return (bytes / 1048576).toFixed(1) + ' MB';
    return (bytes / 1073741824).toFixed(1) + ' GB';
  },

  // Format number with commas
  formatNumber: function(num) {
    if (num == null) return '-';
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  },

  // Debounce function
  debounce: function(func, wait) {
    var timeout;
    return function executedFunction() {
      var context = this;
      var args = arguments;
      var later = function() {
        timeout = null;
        func.apply(context, args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  },

  // Deep clone object
  deepClone: function(obj) {
    return JSON.parse(JSON.stringify(obj));
  },

  // Get query parameter
  getQueryParam: function(name) {
    var urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
  },

  // Show toast notification
  showToast: function(message, type) {
    type = type || 'info';
    Fliplet.UI.Toast({
      message: message,
      type: type
    });
  },

  // Show confirmation dialog
  confirm: function(message, options) {
    options = options || {};
    return new Promise(function(resolve) {
      Fliplet.UI.Actions({
        title: options.title || 'Confirm',
        message: message,
        actions: [
          {
            label: options.confirmLabel || 'Confirm',
            action: function() {
              resolve(true);
            }
          },
          {
            label: options.cancelLabel || 'Cancel',
            action: function() {
              resolve(false);
            }
          }
        ]
      });
    });
  }
};

// Initialize Event Bus when Vue loads
window.addEventListener('vue-loaded', function() {
  if (window.Vue) {
    window.MergeEventBus = window.Vue.createApp({}).config.globalProperties.$eventBus = new window.Vue();
    console.log('MergeEventBus initialized');
  }
});

// Initialize app on document ready
$(document).ready(function() {
  console.log('App Merge UI - Global JS loaded');

  // Check if we need to restore state
  MergeStorage.restoreState().then(function(restored) {
    if (restored) {
      console.log('Merge state restored from localStorage');
    }
  });

  // Get source app ID from URL parameter (passed from Studio)
  var sourceAppId = MergeUtils.getQueryParam('sourceAppId');
  if (sourceAppId) {
    MergeState.sourceApp = { id: parseInt(sourceAppId) };
    console.log('Source app ID:', sourceAppId);
  }
});
```

## Verification

After completing this phase, verify:

- [ ] App context is set to 427998
- [ ] Global CSS is saved and design tokens are accessible
- [ ] Global JS is saved and all utilities are working
- [ ] Vue.js loads successfully from CDN
- [ ] MergeState object is accessible in console
- [ ] MergeStorage can save/retrieve data
- [ ] Utility functions work correctly

## Next Steps

Proceed to [1.2 Design System Components](./1.2-design-system.md) to build reusable UI components.

## Related Documents

- [Phase 1 Overview](../00-overview.md#phase-1-foundation--design-system)
- [Middleware Development Guidelines](../../MIDDLEWARE_GUIDELINES.md)

