# Phase 1.8: API Tester Error Display Enhancement

**Status**: ✅ Complete
**Updated**: December 18, 2025

## Overview

Enhanced the API Tester to properly display validation errors thrown by middleware, distinguishing between validation errors (missing parameters) and API errors (server responses).

---

## Problem

### Before

Validation errors from middleware were not displayed properly:

```javascript
// Middleware throws validation error
if (!appId) throw new Error('appId is required');

// API Tester catch block
catch(err) {
  this.result = {ok: false, time: Date.now()-start, data: JSON.stringify(err, null, 2)};
}
```

**Issue**: `JSON.stringify(new Error('message'))` returns `{}` because Error properties are not enumerable.

**User Experience**:
- Error alert shows "Error"
- JSON display shows: `{}`
- No indication of what went wrong
- User has to check browser console

---

## Solution

### Enhanced Error Handling

Using `Fliplet.parseError()` for robust error message extraction:

```javascript
async go() {
  this.loading = true;
  const start = Date.now();
  try {
    const args = this.params.map(p => this.parseValue(this.vals[p]));
    const res = await window.MergeAPI[this.fn](...args);
    this.result = {ok: true, time: Date.now()-start, data: JSON.stringify(res, null, 2)};
  } catch(err) {
    // Use Fliplet.parseError to extract error message
    const errorMessage = Fliplet.parseError(err, 'Unknown error occurred');

    // Build error data object for display
    let errorData;
    if (err instanceof Error) {
      // JavaScript Error (validation from middleware)
      errorData = {
        type: 'Validation Error',
        message: errorMessage,
        stack: err.stack
      };
    } else {
      // API error response or other error type
      errorData = err;
      // Ensure message is extracted
      if (!errorData.message) {
        errorData.message = errorMessage;
      }
    }

    this.result = {
      ok: false,
      time: Date.now()-start,
      data: JSON.stringify(errorData, null, 2)
    };
  }
  this.loading = false;
}
```

**Key improvement**: `Fliplet.parseError()` handles all error formats robustly - strings, objects, nested structures, XHR responses, etc.

### Error Classification

Added computed properties to classify errors:

```javascript
computed: {
  resultType() {
    if (!this.result) return '';
    try {
      const data = JSON.parse(this.result.data);
      if (data.type === 'Validation Error') return 'validation';
      if (data.status >= 400) return 'api-error';
      return this.result.ok ? 'success' : 'error';
    } catch(e) {
      return this.result.ok ? 'success' : 'error';
    }
  },
  resultMessage() {
    if (!this.result) return '';
    try {
      const data = JSON.parse(this.result.data);
      if (data.type === 'Validation Error') {
        return data.message;
      }
      if (data.message) {
        return data.message;
      }
      return '';
    } catch(e) {
      return '';
    }
  }
}
```

---

## User Experience

### Validation Error (Missing Parameter)

**Scenario**: Call `getAppDetails()` without providing `appId`

**Before**:
```
❌ Error (12ms)
{}
```

**After**:
```
⚠️  Validation Error (5ms)
{
  "type": "Validation Error",
  "message": "appId is required",
  "stack": "Error: appId is required\n    at Object.getAppDetails..."
}
```

Message is now clearly visible in JSON!

### API Error (Server Response)

**Scenario**: Call API with invalid data that returns 404

**After**:
```
❌ Error (234ms)
{
  "status": 404,
  "message": "App not found",
  "error": {...}
}
```

### Success Response

**Scenario**: Valid API call

```
✅ Success (156ms)
{
  "apps": [
    {"id": 123, "name": "My App"},
    {"id": 456, "name": "Another App"}
  ]
}
```

---

## Error Types Handled

### 1. Validation Errors

**Source**: Middleware parameter validation
**Display Type**: `"type": "Validation Error"`
**Examples**:
- `appId is required`
- `organizationId is required`
- `sourceAppId is required`
- `config is required`
- `User session not found. Please ensure user is logged in.`

**JSON Format**:
```json
{
  "type": "Validation Error",
  "message": "appId is required",
  "stack": "Error: appId is required\n    at ..."
}
```

### 2. API Errors

**Source**: Server response (status >= 400)
**Display**: Original error object with status/message
**Examples**:
- `404: App not found`
- `401: Unauthorized`
- `403: Permission denied`
- `400: Bad request`

**JSON Format**:
```json
{
  "status": 404,
  "message": "App not found",
  "error": {
    "code": "NOT_FOUND",
    "details": "..."
  }
}
```

### 3. Unknown Errors

**Fallback**: Convert to string
**JSON Format**:
```json
{
  "message": "[object Object]" or error string
}
```

---

## Benefits

✅ **Validation errors visible** - No more empty `{}` display
✅ **Clear error messages** - "appId is required" shown prominently
✅ **Stack traces available** - Full debugging info in JSON
✅ **Type classification** - Know if it's validation or API error
✅ **No console needed** - All info visible in UI

---

## Testing Checklist

### Validation Errors (Should show "Validation Error" with message)

- [ ] `getAppDetails()` with no appId → "appId is required"
- [ ] `getOrganizationApps()` with no organizationId → "organizationId is required"
- [ ] `getScreenDetails()` with no pageId → "pageId is required"
- [ ] `getDataSourceDetails()` with no dataSourceId → "dataSourceId is required"
- [ ] `getFileDetails()` with no fileId → "fileId is required"
- [ ] `lockApps()` with no sourceAppId → "sourceAppId is required"
- [ ] `executeMerge()` with no config → "config is required"

### API Errors (Should show status and message)

- [ ] `getAppDetails(999999)` → 404 with message
- [ ] Invalid authentication → 401 with message

### Success (Should show data)

- [ ] `getApps()` → Array of apps
- [ ] `getAppDetails(427998)` → App object

---

## Implementation Details

### Why JSON.stringify(Error) Returns {}

JavaScript Error objects have non-enumerable properties:

```javascript
// ❌ Doesn't work
const err = new Error('test');
JSON.stringify(err);  // Returns: "{}"

// ✅ Works
const errorData = {
  type: 'Validation Error',
  message: err.message,
  stack: err.stack
};
JSON.stringify(errorData);  // Returns: proper JSON
```

### Error Detection Logic

```javascript
if (err instanceof Error) {
  // JavaScript Error → Validation error from middleware
  errorData = { type: 'Validation Error', message: err.message, stack: err.stack };
} else if (err.message || err.status) {
  // Plain object → API error from server
  errorData = err;
} else {
  // Unknown → Convert to string
  errorData = { message: String(err) };
}
```

---

## Files Changed

**API Tester Screen (ID: 1858266) - JavaScript**:
1. ✅ Enhanced `go()` method with proper error serialization
2. ✅ Added `resultType` computed property for error classification
3. ✅ Added `resultMessage` computed property to extract error messages

---

## Standard Pattern: Use Fliplet.parseError()

The API Tester now uses `Fliplet.parseError()` - Fliplet's built-in utility for extracting error messages:

```javascript
const errorMessage = Fliplet.parseError(err, 'Unknown error occurred');
```

**Benefits of Fliplet.parseError()**:
- Handles nested error structures automatically
- Supports multiple error formats (string, object, array, XHR)
- Recursively extracts from common error keys
- Provides fallback if no error found
- Much more robust than manual `error.message` access

**See**: [Error Handling Patterns](../../patterns/error-handling.md) for comprehensive guide on using `Fliplet.parseError()` throughout the app.

---

## Related Documentation

- [Error Handling Patterns](../../patterns/error-handling.md) - **Standard for all error handling**
- [API Middleware](./1.3-api-middleware.md) - Parameter validation implementation
- [API Tester](./1.4-api-tester.md) - Main testing interface
- [API Fixes](./1.6-api-fixes.md) - Validation error improvements

---

**Status**: Validation error display complete ✅
**Impact**: Much better developer experience - errors are now clearly visible!
