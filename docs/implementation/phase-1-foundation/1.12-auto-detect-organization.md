# Phase 1.12: Auto-Detect Organization ID

**Status**: ✅ Complete
**Updated**: December 18, 2025
**Related**: Extends Phase 1.11 (UserId Endpoint Fix)

## Overview

Updated `getOrganizationApps()` to automatically detect the organization ID from the Studio environment, eliminating the need for developers to manually pass it.

## Problem

Previously, `getOrganizationApps()` required the developer to explicitly pass `organizationId`:

```javascript
// Old: Always required organizationId parameter
MergeAPI.getOrganizationApps(2, { publisherOnly: true })
```

**Issues**:
- Redundant parameter when app is always loaded in Studio context
- Studio already knows the organization via `Fliplet.Env.get('organizationId')`
- Extra cognitive load for developers

## Solution

Made `organizationId` optional with auto-detection from Studio environment:

```javascript
// New: organizationId is optional
MergeAPI.getOrganizationApps({ publisherOnly: true })

// Still supports explicit organizationId if needed
MergeAPI.getOrganizationApps(2, { publisherOnly: true })
```

## Implementation

### Updated Function Signature

```javascript
/**
 * Get apps in organization for current user
 * Fetches user ID via Studio session, then retrieves their apps
 * @param {number} [organizationId] - Organization ID (auto-detected from Studio if not provided)
 * @param {Object} options
 * @param {boolean} [options.publisherOnly] - Only apps with publisher role
 * @param {boolean} [options.mergeableOnly] - Only mergeable apps
 * @returns {Promise<{apps: Array}>}
 */
getOrganizationApps: function(organizationId, options) {
  // Handle single-argument case where first arg is options
  if (typeof organizationId === 'object' && organizationId !== null && !options) {
    options = organizationId;
    organizationId = null;
  }
  options = options || {};

  // Auto-detect organizationId from Studio environment
  if (!organizationId) {
    organizationId = Fliplet.Env.get('organizationId');
  }
  if (!organizationId) {
    throw new Error('organizationId is required and could not be auto-detected');
  }

  // ... rest of function (fetch userId, make API call)
}
```

## Usage Examples

### Recommended: Auto-Detect (No organizationId Parameter)

```javascript
// Simplest usage - auto-detects organizationId from Studio
MergeAPI.getOrganizationApps({
  publisherOnly: true,
  mergeableOnly: true
}).then(function(response) {
  console.log('Apps:', response.apps);
});

// Even simpler - no options
MergeAPI.getOrganizationApps().then(function(response) {
  console.log('All apps:', response.apps);
});
```

### Explicit organizationId (When Needed)

```javascript
// Useful for testing or cross-organization queries
MergeAPI.getOrganizationApps(123, {
  publisherOnly: true
}).then(function(response) {
  console.log('Apps in org 123:', response.apps);
});
```

## How Auto-Detection Works

```
┌─────────────────────────────────────────────────┐
│ User calls: getOrganizationApps(options)       │
└──────────────────┬──────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────┐
│ Check if organizationId was provided            │
│   - If yes: use it                              │
│   - If no: call Fliplet.Env.get('organizationId') │
└──────────────────┬──────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────┐
│ organizationId found?                           │
│   - Yes: continue to getCurrentUser()           │
│   - No: throw error                             │
└─────────────────────────────────────────────────┘
```

## Parameter Handling

The function intelligently handles different call patterns:

| Call Pattern | organizationId | options | Result |
|-------------|----------------|---------|---------|
| `getOrganizationApps()` | Auto-detect | `{}` | ✅ Uses Studio org |
| `getOrganizationApps({ publisherOnly: true })` | Auto-detect | `{ publisherOnly: true }` | ✅ Uses Studio org with options |
| `getOrganizationApps(123)` | `123` | `{}` | ✅ Uses explicit org 123 |
| `getOrganizationApps(123, { publisherOnly: true })` | `123` | `{ publisherOnly: true }` | ✅ Uses explicit org 123 with options |

## Benefits

### 1. **Cleaner Code**
```javascript
// Before (Phase 1.11)
var orgId = Fliplet.Env.get('organizationId');
MergeAPI.getOrganizationApps(orgId, { publisherOnly: true })

// After (Phase 1.12)
MergeAPI.getOrganizationApps({ publisherOnly: true })
```

### 2. **Fewer Errors**
- No risk of forgetting to pass organizationId
- No risk of passing wrong organizationId

### 3. **Better DX (Developer Experience)**
- Less boilerplate code
- More intuitive API
- Follows principle of least surprise

### 4. **Backwards Compatible**
- Still accepts explicit organizationId
- No breaking changes to existing code

## Other Functions That Could Benefit

Consider applying this pattern to other organization-scoped functions:

### Current Functions (May Already Support This)
- `getOrganizations()` - Returns user's organizations (no orgId needed)
- `getApps(options)` - Has optional `organizationId` filter

### Functions to Review
Check if these would benefit from auto-detection:
- Any function that operates within organization context
- Any function called from screens in Studio

## Testing

### Test Auto-Detection
```javascript
// 1. Test auto-detect works
MergeAPI.getOrganizationApps({ publisherOnly: true })
  .then(function(response) {
    console.log('Auto-detect success:', response.apps);
  });

// 2. Verify correct organizationId used
// Check Network tab: GET /v1/organizations/:orgId/users/:userId/apps
// :orgId should match Fliplet.Env.get('organizationId')
```

### Test Explicit organizationId
```javascript
// 3. Test explicit organizationId still works
var explicitOrgId = 999;
MergeAPI.getOrganizationApps(explicitOrgId, { publisherOnly: true })
  .then(function(response) {
    console.log('Explicit org success:', response.apps);
  });

// 4. Verify correct organizationId used
// Check Network tab: GET /v1/organizations/999/users/:userId/apps
```

### Test Error Handling
```javascript
// 5. Test error when Studio context missing
// (Simulate by temporarily clearing Fliplet.Env mock)
// Should throw: "organizationId is required and could not be auto-detected"
```

## Files Updated

1. ✅ **Global JavaScript (App 427998)**
   - Updated `getOrganizationApps()` with auto-detection logic

2. ✅ **GLOBAL_JS_UPDATE.js**
   - Updated code snippet with new implementation
   - Updated API Tester signature (organizationId now optional)

3. ✅ **docs/implementation/phase-1-foundation/1.11-userid-endpoint-fix.md**
   - Updated to reflect auto-detection

4. ✅ **docs/implementation/phase-1-foundation/1.12-auto-detect-organization.md** (NEW)
   - This document

## Migration Guide

### No Changes Required
Existing code with explicit `organizationId` continues to work:

```javascript
// This still works perfectly
MergeAPI.getOrganizationApps(2, { publisherOnly: true })
```

### Recommended Update
Simplify new code by removing explicit `organizationId`:

```javascript
// Simplify to this
MergeAPI.getOrganizationApps({ publisherOnly: true })
```

## Related Documentation

- [Phase 1.11: UserId Endpoint Fix](./1.11-userid-endpoint-fix.md)
- [Phase 1.10: Session Cookie Authentication](./1.10-session-cookie-authentication.md)
- [Middleware Guidelines](../../MIDDLEWARE_GUIDELINES.md)

---

**Implementation Date**: December 18, 2025
**Deployed**: App 427998 Global JavaScript
**Status**: ✅ Complete - Ready for Testing
